<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Test</title>
		<style>
        
            /* Note: css styles will be overwritten by D3 attributes  */
            
            body { /* HTML element selector */
                background-color: #FBF2EF;
            }

			           
            p {
                font-size: 10px;
                color: black;
                background-color: gray;
                font-style: bold;
                font-family: sans-serif;
            }
            
            #rect-demo { /* id selector,  used to specify a style for a single, unique element */
                fill: red;
                stroke: black;
            }
            
            .barplot { /* class selector, used to specify a style for a group of elements */
                background-color: #e5eecc;
                fill: #8ac007;
            }
            
            #maps { /* id selector,  used to specify a style for a single, unique element */               
                background-color: #364765;
            }
            
            .bar {
              fill: steelblue;
            }
            
            .xaxis path,
            .xaxis line {
                fill: none;
                stroke: black;                
                stroke: black;                
            }
            
            .xaxis text {
                font-family: sans-serif;
                font-size: 9px;
                font-style: bold;
            }
            
            .yaxis path,
            .yaxis line {
                fill: none;
                stroke: black;                
                stroke: black;                
            }
            
            .yaxis text {
                font-family: sans-serif;
                font-size: 10px;
            }
            
            .tooltip  {
                background-color: steelblue;
                font-family: sans-serif;
                font-size: 10px;
            }
            
            /*svg {
                shape-rendering: crispEdges;
            }*/
		</style>
		
        <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
		<script type="text/javascript" src="fisheye.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
         
       
        
        <div id = maps>
            
            <p>Life expectancy (use scrollwheel to zoom, mouse to pan)</p>
            <div id="map-world2"> </div>
            
            
         </div>
        
        <p>Life expectancy plot using <b>merged_db_20130308.csv</b> </p>
        <div id="bars-example"></div>
          
         <p id="debug">
            <b>Debug info</b>
            <br>
         </p>
        
        </div>
    </head>
    <body>	
		
		
		
        <script>
        

       
         /////////////
        // world map 2
        /////////////
        var fisheye = d3.fisheye.circular()
            .radius(200)
            .distortion(2);
        
        
            
        var svgMapWorld2 = d3.select("#map-world2").
                            append("svg").
                                attr("x", 0).
                                attr("y", 0).
                                attr("width", 900).
                                attr("height",500).
                                attr("pointer-events", "all").
                            append("g")
                                .call(d3.behavior.zoom().on("zoom", redraw));
                                
                            
        
        var groupMapWorld2a = svgMapWorld2.append("g").
                attr("id", "group-map-world2").
                attr("class", "LifeExpectancyCountry").               
                attr("x", 0).
                attr("y", 0);
                
          groupMapWorld2a.append("rect")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("opacity", .5)
                    .attr("width", 900)
                    .attr("height",500);
      
        var vis = groupMapWorld2a;           
        function redraw() {
          trans=d3.event.translate;
          scale=d3.event.scale;
          vis.attr("transform",
              "translate(" + trans + ")"
              + " scale(" + scale + ")");
        }
        
        var groupMapWorld2 = groupMapWorld2a;
        
        d3.json("all-countries.json", function(error, collection) {
        
            if (error) {  
                document.getElementById("debug").innerHTML += "Error loading world map file <br>"; 
                return console.warn(error); 
            }
            //console.log(collection);
        
            groupMapWorld2.selectAll("path").
                data(collection.features).
                enter().
                append("path").
                    attr("stroke", "black").
                    attr("id", function(data) { return data.properties.name; }).   
                    //style("fill", function(d) { return '#'+Math.floor(d.properties.name.charCodeAt(0)/100*4620980).toString(16); }).                   
                    attr("d", d3.geo.path().projection(d3.geo.mercator().scale(500).rotate([-10,0,0])));
          
       
        
        
        var rows; // first
        d3.csv("life_expectancy_per_country_CIA.csv", function(data) { // third
            rows = data;
            console.log(rows);            
            doSomethingWithRows();
        });        
        //second
        
        function doSomethingWithRows() {
             var rank = [], countryName = [], years =[];
             //console.log(rows);
             //document.getElementById("debug").innerHTML += d.COUNTRY + "<br>";
             document.getElementById("debug").innerHTML += "loaded separate life exp. per country (rows) <br>";
             rows.map(function(d) {
                rank.push(d.RANK);
                countryName.push(d.COUNTRY);
                years.push(d.YEARS);
            })
            //console.log(rows);
           
           /*groupMapWorld2.selectAll("path").
                data(rows, function(d){return d.id;}).
                    attr("stroke", "black").
                    attr("id", function(data) { return data.COUNTRY; });
                    style("fill", function(data) { return '#'+Math.floor(data.COUNTRY.charCodeAt(0)/100*4620980).toString(16); }).                   
                    
            */

            groupMapWorld2.selectAll("path").
                            //data(rows).
                            style("fill", function(d) {
                                var fillColor = "black";
                                
                                document.getElementById("debug").innerHTML += this.id ;   // json country names
                                var matched = false;
                                
                                for(var i in countryName) { // maybe better use jQuery, for for-each loops
                                    //console.log(countryName[i]);
                                    //alert(countryName[i]);
                                    
                                    
                                    if(countryName[i] == this.id){
                                        matched = true;
                                        document.getElementById("debug").innerHTML += " == " + countryName[i] + " <br>"; 
                                        this.years = years[i];
                                        fillColor = colorLEFunction(years[i]);
                                    }
                                    
                                }  
                                if (matched == false) {
                                     document.getElementById("debug").innerHTML += " == ???????? <br>"; 
                                }
                                return fillColor;                               
                            })
                           // .on("mouseover", function(){return tooltip.style("visibility", "visible");})
                            .on("mouseover", function(d){return tooltip.text(this.id + ": " + this.years).style("visibility","visible");})
                            .on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
                            .on("mouseout", function(){return tooltip.style("visibility", "hidden");});
         }
          });
         
         var colorLEFunction = d3.scale.linear()
            .domain([40, 65,90])
            .range(["darkred", "pink", "#0b640d"]);
 
        var tooltip = d3.select("body")
            .append("div")
            .attr("class","tooltip")
            .style("position", "absolute")
            .style("z-index", "10")
            .style("visibility", "visible")
            .style("color", "white")
            .text("a simple tooltip");
       
        
        ////////////////
        // bar chart
        ///////////////////
       
     
        var barWidth = 40;
        var diagramWidth = 3000;
        var diagramHeight = 400;
        var xAxisHeight = 20;
        // d3.scale.linear() returns a function
        
        var xFun = d3.scale.ordinal()
                    .rangeRoundBands([0, diagramWidth], .3);
                  //  domain([0, exampleData.length]).
                    //.range([0, diagramWidth]);
      
      
        var yFun = d3.scale.linear().    
                   range([diagramHeight, 0]);
        
        var xAxis = d3.svg.axis()
            .scale(xFun)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(yFun)
            .ticks(5)
            .orient("right");

    
        var barsExample = d3.select("#bars-example").
            append("svg"). // inserts <svg .. > tag in div 
            attr("width", diagramWidth).
            attr("height", diagramHeight+20);
        
        //document.getElementById("debug").innerHTML += "selected #bar-demo <br>"; 

        
        var allData; // first
        d3.csv("merged_db_20130308.csv", function(error, data) { // third
            allData = data;
            console.log(allData);       
            var countryArray = new Array(1);
            var yearsArray = new Array(1);
            data.forEach(function(d) {
                //document.getElementById("debug").innerHTML += "d: " + d.YEARS + " <br>";  
                countryArray.push(d.COUNTRY);
                yearsArray.push(d.YEARS);
                
               // document.getElementById("debug").innerHTML += "country: " + d.COUNTRY + " <br>";  
              //  document.getElementById("debug").innerHTML += "years: " + d.YEARS + " <br>";  
                if (d.COUNTRY ) {
                    d.YEARS = +d.YEARS;
                }
            });      
            
            
            xFun.domain(data.map(function(d) {   return d.COUNTRY; }   ));
            yFun.domain([0, d3.max(data, function(d) { return d["YEARS"]; })]);
            
            document.getElementById("debug").innerHTML += "max years: " + d3.max(data, function(d) { return d["YEARS"]; }) + " <br>";  
    
            
            barsExample.selectAll(".bar")
                .data(data)
                .enter()
                    .append("rect")
                        .attr("class","bar")
                        .attr("x", function(d) {return xFun(d.COUNTRY); })
                        .attr("width", xFun.rangeBand())
                        .style("fill", function(d) { if (isNaN(d.YEARS)) {
                                                        return "red";
                                                    }
                                                    else {
                                                        return this.fill;
                                                }})
                        .attr("y", function(d) { if (isNaN(d.YEARS)) {
                                                        return diagramHeight - 10;
                                                    }
                                                    else {
                                                        return yFun(d.YEARS);
                                                }})
                        .attr("height", function(d) { 
                                                        if (isNaN(d.YEARS)) {
                                                            return yFun(10);
                                                        }
                                                        else {
                                                            return diagramHeight- yFun(d.YEARS);
                                                        }
                                                    });
                                                    
            barsExample.append("g")
                .attr("class","xaxis")
                //.attr("transform", "translate(200,100)rotate(180)")
                .attr("transform", "translate(0," + (diagramHeight ) + ")")
                .call(xAxis)
                    .selectAll("text")  
                    .style("text-anchor", "end")
                    .attr("dx", "-0.6m")
                    .attr("dy", -5.5)  // why...??
                    .attr("transform", function(d) {
                        return "translate(0,-5),rotate(70)" 
                    });
                
            barsExample.append("g")
                .attr("class", "yaxis")
                .attr("transform", "translate(" + 10 + ",0)")
                .call(yAxis);
                        
        });  
       
        
                            
        
       
        
        </script>
        
        
    </body>
</html>     